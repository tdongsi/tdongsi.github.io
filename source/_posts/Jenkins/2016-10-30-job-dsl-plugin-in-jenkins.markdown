---
layout: post
title: "Job DSL Plugin in Jenkins"
date: 2016-10-30 18:27:07 -0700
comments: true
categories:
- Jenkins
- Groovy 
---

How Job DSL plugin works and why it is losing its dominance to Jenkins Pipeline.

<!--more-->

### Job DSL

``` groovy Minimal Job DSL
job('Demo') {
    description("Starting pipeline")
    logRotator {
        daysToKeep(15)
    }
    steps {
        shell('echo "Hello World"')
    } 
}
```

To illustrate the idea.
Obviously, lots of work need to be done to make sure the final generated `config.xml` is valid, including escaping special characters.

``` groovy Simple implementation of Job DSL
class GroovyDsl {

    def description(String description) {
        print '<description>'
        print description
        println '</description>'
    }

    def logRotator(Closure inner) {
        println '<logRotator>'
        inner()
        println '</logRotator>'
    }

    def steps(Closure inner) {
        println '<builders>'
        inner()
        println '</builders>'
    }
    
    static void job(String name, Closure closure) {
        GroovyDsl body = new GroovyDsl()

        println "Generating a Freestyle job $name"
        println "Save the following into config.xml file"
        println '<project>'
        body.with(closure)
        println '</project>'
    }

}

def daysToKeep(int num) {
    println "<daysToKeep>$num</daysToKeep>"
    println '<numToKeep>-1</numToKeep>'
    println '<artifactDaysToKeep>-1</artifactDaysToKeep>'
    println '<artifactNumToKeep>-1</artifactNumToKeep>'
}

def shell(String cmd) {
    println '<hudson.tasks.Shell>'
    println '<command>'
    println cmd
    println '</command>'
    println '</hudson.tasks.Shell>'
}

GroovyDsl.job('Demo') {
    description("Starting pipeline")
    logRotator {
        daysToKeep(15)
    }
    steps {
        shell('echo "Hello World"')
    } 
}
```

``` xml Output of the above script
Generating a Freestyle job Demo
Save the following into config.xml file
<project>
<description>Starting pipeline</description>
<logRotator>
<daysToKeep>15</daysToKeep>
<numToKeep>-1</numToKeep>
<artifactDaysToKeep>-1</artifactDaysToKeep>
<artifactNumToKeep>-1</artifactNumToKeep>
</logRotator>
<builders>
<hudson.tasks.Shell>
<command>
echo "Hello World"
</command>
</hudson.tasks.Shell>
</builders>
</project>
```

Compared with the Jenkins config.xml of the Freestyle job generated by the same Job DSL, we can see that there is not much different. 

``` xml Output of config.xml in Jenkins
<project>
<actions/>
<description>Starting pipeline</description>
<keepDependencies>false</keepDependencies>
<properties/>
<scm class="hudson.scm.NullSCM"/>
<canRoam>true</canRoam>
<disabled>false</disabled>
<blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
<blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
<triggers/>
<concurrentBuild>false</concurrentBuild>
<builders>
<hudson.tasks.Shell>
<command>echo "Hello World"</command>
</hudson.tasks.Shell>
</builders>
<publishers/>
<buildWrappers/>
<logRotator>
<daysToKeep>15</daysToKeep>
<numToKeep>-1</numToKeep>
<artifactDaysToKeep>-1</artifactDaysToKeep>
<artifactNumToKeep>-1</artifactNumToKeep>
</logRotator>
</project>
```